{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>{{ document.title }}</h1>
    <div>
        <a href="/dashboard" class="btn btn-outline-secondary">ダッシュボード</a>
    </div>
</div>

{% set active_tab_id = 'intent' %} {# デフォルトは作者の意図 #}
{% set url_hash = request.url.split('#')[-1] if '#' in request.url else '' %}

{% if url_hash == 'units' %}
    {% set active_tab_id = 'units' %}
{% elif url_hash == 'intent' %}
    {% set active_tab_id = 'intent' %}
{% endif %}

<ul class="nav nav-tabs" id="documentTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab_id == 'intent' %}active{% endif %}" id="intent-tab" data-bs-toggle="tab" data-bs-target="#intent" type="button" role="tab" aria-controls="intent" aria-selected="{% if active_tab_id == 'intent' %}true{% else %}false{% endif %}">作者の意図</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab_id == 'units' %}active{% endif %}" id="units-tab" data-bs-toggle="tab" data-bs-target="#units" type="button" role="tab" aria-controls="units" aria-selected="{% if active_tab_id == 'units' %}true{% else %}false{% endif %}">構成要素</button>
    </li>
</ul>

<div class="tab-content" id="documentTabContent">
        <div class="tab-pane fade {% if active_tab_id == 'units' %}show active{% endif %}" id="units" role="tabpanel" aria-labelledby="units-tab">
            <div class="card p-4 shadow-sm mt-3">
                <form method="post" action="/document/{{ document.id }}">
                    <input type="hidden" name="update_composition_elements" value="1">
                    
                    <h2>構成要素の定義</h2> {# 見出しを「定義」に変更 #}

                    {# 共通構成要素 #}
                    {% if COMPOSITION_ELEMENTS_META.common_categories %}
                        <h3 class="mt-4">共通構成要素</h3>
                        {% for category_meta in COMPOSITION_ELEMENTS_META.common_categories %}
                            <div class="border p-3 mb-3 rounded">
                                <h4 class="mb-3">{{ category_meta.label }}</h4>
                                {% set category_id = category_meta.id %}
                                {% set is_multiple = category_meta.multiple %}
                                {% set elements = document.composition_elements.common.get(category_id, []) %}

                                {% if not is_multiple %}
                                    {# multiple: false の場合、単一のインスタンスはラベルのみ表示 #}
                                    {% set instance = elements %}
                                    {% if instance %}
                                        <p class="mb-0"><strong>{{ category_meta.label }}</strong></p>
                                        {# ここでは内容の表示・入力は行わない #}
                                    {% endif %}
                                {% else %}
                                    {# multiple: true の場合、各インスタンスのラベルと削除ボタンを表示 #}
                                    {% if elements %}
                                        {% for instance in elements %}
                                            <div class="mb-2 p-2 border rounded bg-light d-flex justify-content-between align-items-center">
                                                <span>{{ category_meta.label }} #{{ loop.index + 1 }}</span>
                                                <button type="submit" name="remove_element_{{ category_id }}" value="{{ loop.index0 }}" class="btn btn-danger btn-sm">削除</button>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <p>まだ項目がありません。</p>
                                    {% endif %}
                                    <button type="submit" name="add_element_{{ category_id }}" value="1" class="btn btn-success btn-sm mt-2">＋ {{ category_meta.label }}を追加</button>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% endif %}

                    {# doc_type 固有構成要素 #}
                    {% set doc_type_meta = COMPOSITION_ELEMENTS_META.doc_types.get(mapped_doc_type_id) %}
                    {% if doc_type_meta and doc_type_meta.categories %}
                        <h3 class="mt-5">主構成要素 ({{ doc_type_meta.label }})</h3>
                        {% for category_meta in doc_type_meta.categories %}
                            <div class="border p-3 mb-3 rounded">
                                <h4 class="mb-3">{{ category_meta.label }}</h4>
                                {% set category_id = category_meta.id %}
                                {% set is_multiple = category_meta.multiple %}
                                {% set elements = document.composition_elements.doc_type_specific.get(category_id, []) %}

                                {% if not is_multiple %}
                                    {# multiple: false の場合、単一のインスタンスはラベルのみ表示 #}
                                    {% set instance = elements %}
                                    {% if instance %}
                                        <p class="mb-0"><strong>{{ category_meta.label }}</strong></p>
                                        {# ここでは内容の表示・入力は行わない #}
                                    {% endif %}
                                {% else %}
                                    {# multiple: true の場合、各インスタンスのラベルと削除ボタンを表示 #}
                                    {% if elements %}
                                        {% for instance in elements %}
                                            <div class="mb-2 p-2 border rounded bg-light d-flex justify-content-between align-items-center">
                                                <span>{{ category_meta.label }} #{{ loop.index + 1 }}</span>
                                                <button type="submit" name="remove_element_{{ category_id }}" value="{{ loop.index0 }}" class="btn btn-danger btn-sm">削除</button>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <p>まだ項目がありません。</p>
                                    {% endif %}
                                    <button type="submit" name="add_element_{{ category_id }}" value="1" class="btn btn-success btn-sm mt-2">＋ {{ category_meta.label }}を追加</button>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% endif %}

                    <hr class="my-4">
                    {# 内容を保存するボタンは削除、構成要素の構造を保存するボタンは必要 #}
                    <button type="submit" class="btn btn-primary mt-3 me-2">構成要素の構造を保存</button>
                    <a href="/dashboard" class="btn btn-secondary mt-3">← ダッシュボードへ</a>
                </form>
            </div>
        </div>
        <div class="tab-pane fade {% if active_tab_id == 'intent' %}show active{% endif %}" id="intent" role="tabpanel" aria-labelledby="intent-tab">
            <div class="card p-4 shadow-sm mt-3">
                <h2>作者の意図（Intent）</h2>            <form method="post" action="/document/{{ document.id }}/intent">
                {% if document.intent and document.intent.fields %}
                    {% for key, field in document.intent.fields.items() %}
                        <div class="mb-3 d-flex align-items-center">
                            <label class="form-label fw-bold me-2">{{ field.label }}</label>
                            <input
                                type="text"
                                name="intent_value_{{ key }}"
                                value="{{ field.value }}"
                                class="form-control flex-grow-1 me-2"
                            >
                            <button type="submit"
                                    name="remove_intent"
                                    value="{{ key }}"
                                    class="btn btn-danger btn-sm">
                                削除
                            </button>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>このドキュメントには意図が設定されていません。</p>
                {% endif %}

                <hr>

                <h4>Intent項目を追加</h4>
                <div class="mb-3 d-flex">
                    <input
                        type="text"
                        name="new_intent_label"
                        placeholder="項目名（例：世界観）"
                        class="form-control me-2"
                        style="width:30%;"
                    >
                    <input
                        type="text"
                        name="new_intent_value"
                        placeholder="内容"
                        class="form-control me-2"
                        style="width:55%;"
                    >
                    <button type="submit" name="add_intent" value="1" class="btn btn-success">
                        ＋ 追加
                    </button>
                </div>

                <button type="submit" name="save_intent" value="1" class="btn btn-primary mt-3 me-2">
                    Intentを保存
                </button>
                <a href="/dashboard" class="btn btn-secondary mt-3">← ダッシュボードへ</a>
            </form>
        </div>
    </div>
</div>
{% endblock %}