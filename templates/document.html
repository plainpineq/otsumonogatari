{% extends "base.html" %}

{% block content %}
<div class="card p-4 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h2 mb-0">{{ document.title }}</h1>
        <div>
            <a href="/dashboard" class="btn btn-outline-secondary me-2">ダッシュボード</a>
            <form action="/document/{{ document.id }}/download" method="GET" style="display:inline-block;">
                <button type="submit" class="btn btn-info">ダウンロード</button>
            </form>
        </div>
    </div>

<ul class="nav nav-tabs" id="documentTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="intent-tab" data-bs-toggle="tab" data-bs-target="#intent" type="button" role="tab" aria-controls="intent" aria-selected="false">作者の意図</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="composition-tab" data-bs-toggle="tab" data-bs-target="#composition" type="button" role="tab" aria-controls="composition" aria-selected="false">構成要素</button>
    </li>
</ul>

<div class="tab-content" id="documentTabContent">
    <div class="tab-pane fade" id="composition" role="tabpanel" aria-labelledby="composition-tab">
        <div class="card p-4 shadow-sm mt-3">
            <form method="post" action="/document/{{ document.id }}">
                <input type="hidden" name="update_composition_elements" value="1">

                <h2 class="h4 mb-3">構成要素の定義</h2> {# 見出しを「定義」に変更 #}

                {# 共通構成要素 #}
                {% set common_meta_data = document.composition_meta.common_categories %}
                {% set common_categories_data = document.composition_elements.common.categories %}
                {% if common_meta_data.categories %}
                    <h3 class="h5 mt-4">{{ common_meta_data.label }}</h3>
                    {% if common_meta_data.editable %}
                        <div class="mb-3 d-flex">
                            <input type="text" name="new_common_category_label" placeholder="新しい共通構成要素のラベル" class="form-control me-2">
                            <button type="submit" name="add_common_category" value="1" class="btn btn-primary">追加</button>
                        </div>
                    {% endif %}

                    {% for category in common_categories_data %}
                        {# Get meta for default categories, for user-added ones it will be none #}
                        {% set category_meta = common_meta_data.categories | selectattr("id", "equalto", category.id) | first %}
                        <div class="card p-3 mb-3">
                            <h4 class="h6 mb-3 d-flex justify-content-between align-items-center">
                                <input type="text" name="category_{{ category.id }}_label" value="{{ category.label }}" class="form-control me-2 category-input">
                                <button type="submit" name="remove_common_category" value="{{ category.id }}" class="btn btn-danger btn-sm ms-2">削除</button>
                            </h4>
                            {% set category_id = category.id %}
                            {% set elements = category.elements %}

                            {% if elements %}
                                {% for element in elements %}
                                    <div class="mb-2 d-flex align-items-center">
                                        <input
                                            type="text"
                                            name="element_{{ category_id }}_{{ loop.index0 }}_label"
                                            value="{{ element.label }}"
                                            class="form-control me-2"
                                            placeholder="{{ category.label }} #{{ loop.index + 1 }}"
                                        >
                                        <button type="submit" name="remove_element_{{ category_id }}" value="{{ loop.index0 }}" class="btn btn-danger btn-sm">削除</button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endif %}

                {# doc_type 固有構成要素 #}
                {% set doc_type_meta_data = document.composition_meta.doc_types.get(mapped_doc_type_id) %}
                {% if doc_type_meta_data and doc_type_meta_data.categories %}
                    <h3 class="h5 mt-5">主構成要素 ({{ doc_type_meta_data.label }})</h3>
                    {% if doc_type_meta_data.editable %}
                        <div class="mb-3 d-flex">
                            <input type="text" name="new_doc_type_category_label" placeholder="新しい分類のラベル" class="form-control me-2">
                            <button type="submit" name="add_doc_type_category" value="1" class="btn btn-primary">分類追加</button>
                        </div>
                    {% endif %}

                    {% set doc_type_categories_data = document.composition_elements.doc_type_specific.categories %}
                    {% for category in doc_type_categories_data %}
                        {% set category_meta = doc_type_meta_data.categories | selectattr("id", "equalto", category.id) | first %}
                        <div class="card p-3 mb-3">
                            <h4 class="h6 mb-3 d-flex justify-content-between align-items-center">
                                {% if category.editable %}
                                    <input type="text" name="category_{{ category.id }}_label" value="{{ category.label }}" class="form-control me-2 category-input">
                                {% else %}
                                    <span>{{ category.label }}</span>
                                {% endif %}
                                
                                {% if doc_type_meta_data.editable and category.editable %}
                                    <button type="submit" name="remove_doc_type_category" value="{{ category.id }}" class="btn btn-danger btn-sm ms-2">分類削除</button>
                                {% endif %}
                            </h4>
                            {% set category_id = category.id %}
                            {% set elements = category.elements %}

                            {% if elements %}
                                {% for element in elements %}
                                    <div class="mb-2 d-flex align-items-center">
                                        <input
                                            type="text"
                                            name="element_{{ category_id }}_{{ loop.index0 }}_label" {# ラベル編集用 #}
                                            value="{{ element.label }}"
                                            class="form-control me-2"
                                            placeholder="{{ category.label }} #{{ loop.index + 1 }}"
                                        >
                                        <button type="submit" name="remove_element_{{ category_id }}" value="{{ loop.index0 }}" class="btn btn-danger btn-sm">削除</button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                            
                            {% if category.editable %}
                                <button type="submit" name="add_element_{{ category_id }}" value="1" class="btn btn-success btn-sm mt-2">＋ {{ category.label }}を追加</button>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endif %}

                <hr class="my-4">
                <button type="submit" class="btn btn-primary mt-3 me-2">構成要素の構造を保存</button>
                <a href="/dashboard" class="btn btn-secondary mt-3">← ダッシュボードへ</a>
            </form>
        </div>
    </div>
    <div class="tab-pane fade" id="intent" role="tabpanel" aria-labelledby="intent-tab">
        <div class="card p-4">
            <h2 class="h4 mb-3">作者の意図（Intent）</h2>            <form method="post" action="/document/{{ document.id }}/intent">
                {% if document.intent and document.intent.fields %}
                    {% for key, field in document.intent.fields.items() %}
                        <div class="mb-3 d-flex align-items-center">
                            <label class="form-label fw-bold me-2">{{ field.label }}</label>
                            <input
                                type="text"
                                name="intent_value_{{ key }}"
                                value="{{ field.value }}"
                                class="form-control flex-grow-1 me-2"
                            >
                            <button type="submit"
                                    name="remove_intent"
                                    value="{{ key }}"
                                    class="btn btn-danger btn-sm">
                                退避
                            </button>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>このドキュメントには意図が設定されていません。</p>
                {% endif %}

                <hr class="my-4">

                <h4 class="h5 mb-3">Intent項目を追加</h4>
                <div class="mb-3 d-flex">
                    <input
                        type="text"
                        name="new_intent_label"
                        placeholder="項目名（例：世界観）"
                        class="form-control me-2"
                        style="width:30%;"
                    >
                    <input
                        type="text"
                        name="new_intent_value"
                        placeholder="内容"
                        class="form-control me-2"
                        style="width:55%;"
                    >
                    <button type="submit" name="add_intent" value="1" class="btn btn-success">
                        ＋ 追加
                    </button>
                </div>

                <div class="d-flex justify-content-between">
                    <button type="submit" name="save_intent" value="1" class="btn btn-primary">
                        Intentを保存
                    </button>
                    <a href="/dashboard" class="btn btn-secondary">← ダッシュボードへ</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Activate tab based on URL hash
        let hash = window.location.hash;
        let tabToActivate;

        if (hash) {
            tabToActivate = document.querySelector('.nav-tabs button[data-bs-target="' + hash + '"]');
        }

        if (tabToActivate) {
            new bootstrap.Tab(tabToActivate).show();
        } else {
            // Activate the default tab ('intent') if no hash or hash is invalid
            let defaultTab = document.getElementById('intent-tab');
            if (defaultTab) {
                new bootstrap.Tab(defaultTab).show();
            }
        }
    });
</script>
{% endblock %}
