{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>{{ document.title }}</h1>
    <div>
        <a href="/dashboard" class="btn btn-outline-secondary">ダッシュボード</a>
    </div>
</div>

<ul class="nav nav-tabs" id="documentTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="intent-tab" data-bs-toggle="tab" data-bs-target="#intent" type="button" role="tab" aria-controls="intent" aria-selected="true">作者の意図</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="units-tab" data-bs-toggle="tab" data-bs-target="#units" type="button" role="tab" aria-controls="units" aria-selected="false">構成要素 (シーン)</button>
    </li>
</ul>

<div class="tab-content" id="documentTabContent">
        <div class="tab-pane fade" id="units" role="tabpanel" aria-labelledby="units-tab">
            <div class="card p-4 shadow-sm mt-3">
                <h2>シーン</h2>
                <form method="post">
                    {% for unit in document.units %}
                        <h3 class="mt-4">{{ unit.title }}</h3>
                        <textarea
                          name="unit_{{ loop.index0 }}"
                          rows="6"
                          class="form-control"
                        >{{ unit.content }}</textarea>
                        <button type="submit" formaction="/document/{{ document.id }}/improve/{{ loop.index0 }}" class="btn btn-sm btn-secondary mt-2">LLMに改善提案を求める</button>
                    {% endfor %}
                                                    <br>
                                                    <button type="submit" class="btn btn-primary mt-3 me-2">構成要素を保存</button>
                                                    <a href="/dashboard" class="btn btn-secondary mt-3">← ダッシュボードへ</a>
                                                </form>            </div>
        </div>
        <div class="tab-pane fade show active" id="intent" role="tabpanel" aria-labelledby="intent-tab">
            <div class="card p-4 shadow-sm mt-3">
                <h2>作者の意図（Intent）</h2>            <form method="post" action="/document/{{ document.id }}/intent">
                {% if document.intent and document.intent.fields %}
                    {% for key, field in document.intent.fields.items() %}
                        <div class="mb-3 d-flex align-items-center">
                            <label class="form-label fw-bold me-2">{{ field.label }}</label>
                            <input
                                type="text"
                                name="intent_value_{{ key }}"
                                value="{{ field.value }}"
                                class="form-control flex-grow-1 me-2"
                            >
                            <button type="submit"
                                    name="remove_intent"
                                    value="{{ key }}"
                                    class="btn btn-danger btn-sm">
                                削除
                            </button>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>このドキュメントには意図が設定されていません。</p>
                {% endif %}

                <hr>

                <h4>Intent項目を追加</h4>
                <div class="mb-3 d-flex">
                    <input
                        type="text"
                        name="new_intent_label"
                        placeholder="項目名（例：世界観）"
                        class="form-control me-2"
                        style="width:30%;"
                    >
                    <input
                        type="text"
                        name="new_intent_value"
                        placeholder="内容"
                        class="form-control me-2"
                        style="width:55%;"
                    >
                    <button type="submit" name="add_intent" value="1" class="btn btn-success">
                        ＋ 追加
                    </button>
                </div>

                <button type="submit" name="save_intent" value="1" class="btn btn-primary mt-3 me-2">
                    Intentを保存
                </button>
                <a href="/dashboard" class="btn btn-secondary mt-3">← ダッシュボードへ</a>
            </form>
        </div>
    </div>
</div>
{% endblock %}